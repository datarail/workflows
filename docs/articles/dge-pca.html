<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Principal Component Analysis of DGE data • workflows</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Principal Component Analysis of DGE data">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">workflows</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    DGE
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dge-wrangle.html">Wrangling bcbio output</a>
    </li>
    <li>
      <a href="../articles/dge-pca.html">Principal Component Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Helper Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/datarail/workflows">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Principal Component Analysis of DGE data</h1>
                        <h4 class="author">Artem Sokolov</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/datarail/workflows/blob/master/vignettes/dge-pca.Rmd"><code>vignettes/dge-pca.Rmd</code></a></small>
      <div class="hidden name"><code>dge-pca.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette covers applying Principal Component Analysis (PCA) to an example DGE dataset from a real experiment at the LSP. As we’ll see, the largest amount of effort goes into make the data <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidy</a>. Once the data is in a tidy format, applying PCA requires only two lines of code: one to compute the decomposition, and another to project the data onto the first <code>k</code> components.</p>
<p>We begin by loading the necessary libraries. If you followed installation instructions on the main page, all these libraries should have been automatically installed in your environment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>( tidyverse )
<span class="kw">library</span>( magrittr )
<span class="kw">library</span>( broom )</code></pre></div>
</div>
<div id="loading-and-tidying-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-and-tidying-the-data" class="anchor"></a>Loading and tidying the data</h2>
<p>The data for this workflow is <a href="https://www.synapse.org/#!Synapse:syn9952381">hosted on Synapse</a>. We can download it to a local directory by running</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">workflows<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/workflows/topics/getData">getData</a></span>( <span class="st">"dge-pca"</span> )</code></pre></div>
<p>which will request you to sign in to Synapse (if this is the first time) and download the data to <code>data/dge-pca</code> on your current path. Feel free to open the files in a text editor to get a bit familiar with them.</p>
<p>For the rest of the vignette, we will follow tidy data conventions, <a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">as introduced by Hadley Wickham</a>. Specifically, we need to arrange our data into a format that places each sample into a row with columns corresponding to individual properties, such as expression of a particular gene, or the drug that the sample was treated with.</p>
<p>We begin by loading expression data. Note that by default count tables arrange samples in columns and genes in rows. Thus, our processing steps will consist of a) loading the raw data; b) applying a log2 transform; c) transposing the matrix to place samples into rows; and d) fixing sample names. The last step is necessary because sample names between expression and metadata files are mismatched, and we will need them to match exactly when we merge the two data frames later.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fnX &lt;-<span class="st"> "data/dge-pca/M3.unq.refseq.umi.dat"</span>
X &lt;-<span class="st"> </span><span class="kw">read.delim</span>( fnX, <span class="dt">row.names=</span><span class="dv">1</span> ) <span class="op">%&gt;%</span><span class="st">                 </span>## Load the raw data
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/magrittr/topics/aliases">add</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">log2</span>() <span class="op">%&gt;%</span><span class="st">                     </span>## Apply log transform: log2( x + 1 )
<span class="st">    </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st">                         </span>## Transpose to samples-in-row format
<span class="st">    </span><span class="kw">rownames_to_column</span>( <span class="st">"SampleID"</span> ) <span class="op">%&gt;%</span><span class="st">                </span>## Place sample names into their own column
<span class="st">    </span><span class="kw">mutate</span>( <span class="dt">SampleID =</span> <span class="kw">str_split</span>( SampleID, <span class="st">"_"</span>,        ## Fix the names: e.g., T384s1_A1 -&gt; A1
                                 <span class="dt">simplify=</span><span class="ot">TRUE</span> )[,<span class="dv">2</span>] )</code></pre></div>
<p>Depending on how your own data looks, you may or may not need all of these steps. A good exercise is to run a portion of the code and examine the output of each step.</p>
<p>Let’s take a look at the first few rows and columns of the data frame, to verify that things look correctly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">X[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</code></pre></div>
<pre><code>##   SampleID     A1BG A1BG-AS1 A1CF      A2M
## 1       A1 0.000000        0    0 0.000000
## 2       A2 1.584963        0    0 1.584963
## 3       A3 1.000000        0    0 1.584963</code></pre>
<p>Next, we load the metadata. It is already in the format that contains samples in rows. However, we still need to compose sample IDs to match what is in the expression data frame <code>X</code>. We would also like to simplify the column names to avoid overly verbose code. (Note that the original column names can always be saved to another variable and used as visual elements in subsequent plotting.) Finally, because the metadata was stitched from multiple sources, the <code>Drug</code> column contains multiple entries for the same compounds in mismatched capitalization. For example, it contains “dmso” and “DMSO”, “Sorafenib” and “sorafenib”. We consolidate the discrepancies by making each drug name capitalized, except DMSO, which is treated as a special case.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fnY &lt;-<span class="st"> "data/dge-pca/FDA_DGE_metadata.csv"</span>
Y &lt;-<span class="st"> </span><span class="kw">read_csv</span>( fnY ) <span class="op">%&gt;%</span><span class="st">                                </span>## Load the raw data
<span class="st">    </span><span class="kw">mutate</span>( <span class="dt">SampleID =</span> <span class="kw">str_c</span>( Row, Column ) ) <span class="op">%&gt;%</span><span class="st">       </span>## Compose the sample IDs from Row, Column
<span class="st">    </span><span class="kw">select</span>( SampleID, <span class="dt">Origin =</span> <span class="st">`</span><span class="dt">Sample Origonator</span><span class="st">`</span>,     ## Select the variables of interest and
           <span class="dt">Drug =</span> <span class="st">`</span><span class="dt">Drug treatment or Condition</span><span class="st">`</span>,        ##   rename them to shorter tags
           <span class="dt">Time =</span> <span class="st">`</span><span class="dt">Time of Treatment (Days)</span><span class="st">`</span>,
           <span class="dt">Concentration =</span> <span class="st">`</span><span class="dt">Drug Concentration (uM)</span><span class="st">`</span> ) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>( <span class="dt">Drug =</span> <span class="kw">str_to_title</span>(Drug) ) <span class="op">%&gt;%</span><span class="st">             </span>## Consolidate capitalization of drug names
<span class="st">    </span><span class="kw">mutate</span>( <span class="dt">Drug =</span> <span class="kw">ifelse</span>( Drug <span class="op">==</span><span class="st"> "Dmso"</span>, <span class="st">"DMSO"</span>, Drug ) )</code></pre></div>
<p>The goal of using a “messy” dataset is to demonstrate that real data often contains many artifacts and typos and is almost never ready to be fed directly to analysis scripts. In many cases, a large portion of your time can be tied up with wrangling and tidying datasets, so it’s important to collect data with these wrangling steps in mind. Be kind to the future you!</p>
<p>Once again, we verify the first few rows and columns of the metadata frame to make sure things look as expected.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Y[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,]</code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   SampleID Origin Drug     Time  Concentration
##   &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;        
## 1 A1       Mirra  Afatinib 1     1            
## 2 A2       Mirra  Afatinib 5     3.16         
## 3 A3       Mirra  Afatinib 1     3.16</code></pre>
<p>Now that we have both expression and metadata in a tidy format, we can combine everything into a single data frame, using the now-matching sample IDs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">XY &lt;-<span class="st"> </span><span class="kw">inner_join</span>( Y, X )</code></pre></div>
<pre><code>## Joining, by = "SampleID"</code></pre>
<p>Note that by passing <code>Y</code> as the first argument, the join operation will place its columns to the left of <code>X</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">XY[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>]</code></pre></div>
<pre><code>## # A tibble: 3 x 8
##   SampleID Origin Drug     Time  Concentration  A1BG `A1BG-AS1`  A1CF
##   &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;
## 1 A1       Mirra  Afatinib 1     1              0             0     0
## 2 A2       Mirra  Afatinib 5     3.16           1.58          0     0
## 3 A3       Mirra  Afatinib 1     3.16           1.00          0     0</code></pre>
</div>
<div id="principal-components-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#principal-components-analysis" class="anchor"></a>Principal Components Analysis</h2>
<p>We would like to perform PCA on all the “gene” columns in our joint data frame. To say it another way, we would like to exclude columns <code>SampleID</code> through <code>Concentration</code>, which is accomplished through a simple <code>select</code> call. After performing PCA, we augment the original data matrix with the sample projections onto each principal component. The final results matrix is then composed by selecting columns <code>SampleID</code> through <code>Concentration</code>, and projections onto the first two principal components</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">PCA &lt;-<span class="st"> </span><span class="kw">select</span>( XY, <span class="op">-</span>(SampleID<span class="op">:</span>Concentration) ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prcomp</span>()
RR &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment</a></span>( PCA, XY ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>( SampleID<span class="op">:</span>Concentration, .fittedPC1, .fittedPC2 )
RR[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,]</code></pre></div>
<pre><code>##   SampleID Origin     Drug Time Concentration .fittedPC1  .fittedPC2
## 1       A1  Mirra Afatinib    1             1  -30.50101 -0.05008641
## 2       A2  Mirra Afatinib    5          3.16   82.32823  3.62423011
## 3       A3  Mirra Afatinib    1          3.16   48.21466 -0.37240636</code></pre>
</div>
<div id="plotting-the-results" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-the-results" class="anchor"></a>Plotting the results</h2>
<p>It is often useful to present the amount of variance captured by each principal component. This can be retrieved from the <code>PCA</code> object computed above. We scale the variance to be percent of the total and wrap it inside some text to be displayed as the axis labels. Because we’re going to be rerunning PCA multiple times, the underlying % variance explained will change, and the labels will need to be re-generated. We wrap the following code inside a function to make our lives easier.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mylabels &lt;-<span class="st"> </span><span class="cf">function</span>( i, j )
    {
        pcvar &lt;-<span class="st"> </span>PCA<span class="op">$</span>sdev <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>( PCA<span class="op">$</span>sdev ) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>
        xlabel &lt;-<span class="st"> </span><span class="kw">str_c</span>( <span class="st">"PC"</span>, i, <span class="st">": "</span>, <span class="kw">round</span>( pcvar[i], <span class="dv">2</span> ), <span class="st">"% Variance"</span> )
        ylabel &lt;-<span class="st"> </span><span class="kw">str_c</span>( <span class="st">"PC"</span>, j, <span class="st">": "</span>, <span class="kw">round</span>( pcvar[j], <span class="dv">2</span> ), <span class="st">"% Variance"</span> )
        <span class="kw">labs</span>( <span class="dt">x =</span> xlabel, <span class="dt">y =</span> ylabel )
    }</code></pre></div>
<p>We are now ready to produce the PCA plot. The plot below is colored by the <code>Origin</code> attribute to investigate the presence of potential batch effects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>( RR, <span class="kw">aes</span>( <span class="dt">x =</span> .fittedPC1, <span class="dt">y =</span> .fittedPC2, <span class="dt">color =</span> Origin ) ) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>( <span class="dt">size =</span> <span class="dv">3</span> ) <span class="op">+</span><span class="st"> </span><span class="kw">mylabels</span>(<span class="dv">1</span>,<span class="dv">2</span>)</code></pre></div>
<p><img src="dge-pca_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>The plot above shows a strong batch effect between <code>Feo</code> samples and the rest of the data. Let’s repeat the analysis after removing <code>Feo</code> and <code>-</code> samples (the latter corresponding to empty wells).</p>
</div>
<div id="repeating-the-analysis-on-a-subset-of-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#repeating-the-analysis-on-a-subset-of-the-data" class="anchor"></a>Repeating the analysis on a subset of the data</h2>
<p>We begin by filtering the joint matrix according to the <code>Origin</code> attribute. We then repeat the PCA workflow, but keep the first few principal components this time</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">XY &lt;-<span class="st"> </span><span class="kw">filter</span>( XY, Origin <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>( <span class="st">"Sharon"</span>, <span class="st">"Mirra"</span> ) )
PCA &lt;-<span class="st"> </span><span class="kw">select</span>( XY, <span class="op">-</span>(SampleID<span class="op">:</span>Concentration) ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prcomp</span>()
RR &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment</a></span>( PCA, XY ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>( SampleID<span class="op">:</span>Concentration, .fittedPC1<span class="op">:</span>.fittedPC5 )</code></pre></div>
<p>First, we double check that there’s no batch effect in the remaining data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>( RR, <span class="kw">aes</span>( <span class="dt">x =</span> .fittedPC1, <span class="dt">y =</span> .fittedPC2, <span class="dt">color =</span> Origin ) ) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>( <span class="dt">size =</span> <span class="dv">3</span> ) <span class="op">+</span><span class="st"> </span><span class="kw">mylabels</span>(<span class="dv">1</span>,<span class="dv">2</span>)</code></pre></div>
<p><img src="dge-pca_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>We can now recolor the plot by the attributes of interest</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>( RR, <span class="kw">aes</span>( <span class="dt">x =</span> .fittedPC1, <span class="dt">y =</span> .fittedPC2, <span class="dt">color =</span> Drug, <span class="dt">shape =</span> Time ) ) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>( <span class="dt">size =</span> <span class="dv">3</span> ) <span class="op">+</span><span class="st"> </span><span class="kw">mylabels</span>(<span class="dv">1</span>,<span class="dv">2</span>)</code></pre></div>
<p><img src="dge-pca_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>or look at other principal components.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>( RR, <span class="kw">aes</span>( <span class="dt">x =</span> .fittedPC3, <span class="dt">y =</span> .fittedPC4, <span class="dt">color =</span> Drug, <span class="dt">shape =</span> Time ) ) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>( <span class="dt">size =</span> <span class="dv">3</span> ) <span class="op">+</span><span class="st"> </span><span class="kw">mylabels</span>(<span class="dv">3</span>,<span class="dv">4</span>)</code></pre></div>
<p><img src="dge-pca_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#loading-and-tidying-the-data">Loading and tidying the data</a></li>
      <li><a href="#principal-components-analysis">Principal Components Analysis</a></li>
      <li><a href="#plotting-the-results">Plotting the results</a></li>
      <li><a href="#repeating-the-analysis-on-a-subset-of-the-data">Repeating the analysis on a subset of the data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p><img src="http://hits.harvard.edu/wp-content/uploads/2013/10/title_program_lsp1.png" height="50px"></p>
  
</div>

<div class="pkgdown">
  <p>This vignette is a part of
    the <a href="https://github.com/datarail/workflows">"LSP analysis
      workflows"</a> GitHub repo.<br>
  Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
